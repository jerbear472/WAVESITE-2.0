<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Avatar Upload</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        h1 {
            color: #3b82f6;
            margin-bottom: 30px;
        }
        .section {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        input[type="file"] {
            display: block;
            margin: 10px 0;
            padding: 10px;
            background: #333;
            border: 1px solid #444;
            border-radius: 4px;
            color: #fff;
            width: 100%;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #2563eb;
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .success {
            color: #10b981;
            margin: 10px 0;
            padding: 10px;
            background: #064e3b;
            border-radius: 4px;
        }
        .error {
            color: #ef4444;
            margin: 10px 0;
            padding: 10px;
            background: #7f1d1d;
            border-radius: 4px;
        }
        .info {
            color: #60a5fa;
            margin: 10px 0;
            padding: 10px;
            background: #1e3a8a;
            border-radius: 4px;
        }
        img {
            max-width: 200px;
            height: auto;
            border-radius: 8px;
            margin: 10px 0;
        }
        .code {
            background: #000;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            overflow-x: auto;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>üé® Test Avatar Upload</h1>
    
    <div class="section">
        <h2>Step 1: Initialize Supabase</h2>
        <p>Open browser console to see detailed logs</p>
        <div id="init-status" class="info">Not initialized</div>
    </div>

    <div class="section">
        <h2>Step 2: Sign In (Required)</h2>
        <p>You must be signed in to test avatar upload due to RLS policies</p>
        <input type="email" id="email" placeholder="Email" value="">
        <input type="password" id="password" placeholder="Password" type="password" value="">
        <button onclick="signIn()">Sign In</button>
        <button onclick="checkAuth()">Check Auth Status</button>
        <div id="auth-status" class="info">Not signed in</div>
    </div>

    <div class="section">
        <h2>Step 3: Test Upload</h2>
        <input type="file" id="avatar" accept="image/*">
        <button onclick="testUpload()" id="upload-btn" disabled>Upload Avatar</button>
        <div id="upload-status"></div>
        <div id="avatar-preview"></div>
    </div>

    <div class="section">
        <h2>SQL to Fix RLS (if needed)</h2>
        <div class="code">
-- If you get RLS errors, run this in Supabase SQL Editor:

-- Simple policy that allows all authenticated users to upload
CREATE POLICY "Allow authenticated uploads"
ON storage.objects
FOR INSERT
TO authenticated
WITH CHECK (bucket_id = 'avatars');

-- Allow updates
CREATE POLICY "Allow authenticated updates"
ON storage.objects
FOR UPDATE
TO authenticated
USING (bucket_id = 'avatars')
WITH CHECK (bucket_id = 'avatars');

-- Allow deletes
CREATE POLICY "Allow authenticated deletes"
ON storage.objects
FOR DELETE
TO authenticated
USING (bucket_id = 'avatars');

-- Allow public viewing
CREATE POLICY "Allow public viewing"
ON storage.objects
FOR SELECT
TO public
USING (bucket_id = 'avatars');
        </div>
    </div>

    <script>
        // Initialize Supabase - you'll need to update these values
        const SUPABASE_URL = 'https://aicahushpcslwjwrlqbo.supabase.co';
        const SUPABASE_ANON_KEY = 'YOUR_ANON_KEY'; // Get from Supabase dashboard
        
        let supabase;
        let currentUser = null;

        // Try to get credentials from parent window if embedded
        if (window.location.search.includes('url=') && window.location.search.includes('key=')) {
            const params = new URLSearchParams(window.location.search);
            const url = params.get('url');
            const key = params.get('key');
            if (url && key) {
                initSupabase(url, key);
            }
        }

        function initSupabase(url = SUPABASE_URL, key = SUPABASE_ANON_KEY) {
            try {
                supabase = supabaseClient.createClient(url, key);
                document.getElementById('init-status').className = 'success';
                document.getElementById('init-status').textContent = '‚úÖ Supabase initialized with ' + url;
                console.log('Supabase initialized', { url });
                checkAuth();
            } catch (error) {
                document.getElementById('init-status').className = 'error';
                document.getElementById('init-status').textContent = '‚ùå Failed to initialize: ' + error.message;
                console.error('Init error:', error);
            }
        }

        async function signIn() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                alert('Please enter email and password');
                return;
            }

            if (!supabase) {
                alert('Initialize Supabase first with your project credentials');
                return;
            }

            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });

                if (error) throw error;

                currentUser = data.user;
                document.getElementById('auth-status').className = 'success';
                document.getElementById('auth-status').textContent = '‚úÖ Signed in as: ' + email;
                document.getElementById('upload-btn').disabled = false;
                console.log('Signed in:', data);
            } catch (error) {
                document.getElementById('auth-status').className = 'error';
                document.getElementById('auth-status').textContent = '‚ùå Sign in failed: ' + error.message;
                console.error('Sign in error:', error);
            }
        }

        async function checkAuth() {
            if (!supabase) {
                document.getElementById('auth-status').textContent = 'Supabase not initialized';
                return;
            }

            try {
                const { data: { user } } = await supabase.auth.getUser();
                
                if (user) {
                    currentUser = user;
                    document.getElementById('auth-status').className = 'success';
                    document.getElementById('auth-status').textContent = '‚úÖ Authenticated as: ' + user.email;
                    document.getElementById('upload-btn').disabled = false;
                    console.log('Current user:', user);
                } else {
                    document.getElementById('auth-status').className = 'info';
                    document.getElementById('auth-status').textContent = 'Not signed in';
                    document.getElementById('upload-btn').disabled = true;
                }
            } catch (error) {
                document.getElementById('auth-status').className = 'error';
                document.getElementById('auth-status').textContent = '‚ùå Auth check failed: ' + error.message;
                console.error('Auth check error:', error);
            }
        }

        async function testUpload() {
            const fileInput = document.getElementById('avatar');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a file');
                return;
            }

            if (!currentUser) {
                alert('Please sign in first');
                return;
            }

            const statusDiv = document.getElementById('upload-status');
            const previewDiv = document.getElementById('avatar-preview');
            
            statusDiv.className = 'info';
            statusDiv.textContent = '‚è≥ Uploading...';

            try {
                // Create file path with user ID folder
                const fileExt = file.name.split('.').pop();
                const fileName = `${currentUser.id}/avatar-${Date.now()}.${fileExt}`;
                
                console.log('Attempting upload:', { fileName, fileSize: file.size, fileType: file.type });

                // Upload file
                const { data, error } = await supabase.storage
                    .from('avatars')
                    .upload(fileName, file, {
                        cacheControl: '3600',
                        upsert: true
                    });

                if (error) {
                    throw error;
                }

                // Get public URL
                const { data: { publicUrl } } = supabase.storage
                    .from('avatars')
                    .getPublicUrl(fileName);

                statusDiv.className = 'success';
                statusDiv.innerHTML = `
                    ‚úÖ Upload successful!<br>
                    Path: ${fileName}<br>
                    URL: <a href="${publicUrl}" target="_blank" style="color: #60a5fa">${publicUrl}</a>
                `;
                
                previewDiv.innerHTML = `<img src="${publicUrl}" alt="Avatar preview">`;
                
                console.log('Upload successful:', { data, publicUrl });

            } catch (error) {
                statusDiv.className = 'error';
                statusDiv.innerHTML = `
                    ‚ùå Upload failed: ${error.message}<br>
                    <br>
                    ${error.message.includes('row-level security') ? 
                        '<strong>This is an RLS error. Run the SQL queries shown below in your Supabase SQL Editor.</strong>' : 
                        'Check browser console for details'}
                `;
                console.error('Upload error:', error);
            }
        }

        // Initialize on load if credentials are provided
        window.addEventListener('load', () => {
            if (SUPABASE_URL !== 'YOUR_SUPABASE_URL' && SUPABASE_ANON_KEY !== 'YOUR_ANON_KEY') {
                initSupabase();
            } else {
                document.getElementById('init-status').innerHTML = `
                    ‚ö†Ô∏è Update the SUPABASE_URL and SUPABASE_ANON_KEY in this file<br>
                    Get these from your Supabase dashboard > Settings > API
                `;
            }
        });
    </script>
</body>
</html>